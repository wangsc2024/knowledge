<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Python 正規表達式安全模式與 Shell 命令注入防護完整指南（2026）">
  <title>Python 正規表達式安全模式與 Shell 命令注入防護完整指南（2026） | 知識庫</title>
  <link rel="stylesheet" href="../styles.css">
</head>
<body>
  <div class="reading-progress" id="readingProgress"></div>
  <header>
    <div class="container">
      <a href="../" class="logo">知識庫</a>
      <nav>
        <a href="../#buddhism">佛學</a>
        <a href="../#thinking">思維方法</a>
        <a href="../#ai">AI技術</a>
        <a href="../#claude">Claude Code</a>
        <a href="../#game">遊戲</a>
      </nav>
      <button class="theme-toggle" onclick="toggleTheme()" aria-label="切換深色模式">
        <span class="theme-icon">&#9680;</span>
      </button>
    </div>
  </header>

  <main class="container">
    <article>
      <div class="article-header">
        <span class="category-badge category-claude">Claude Code</span>
        <h1>Python 正規表達式安全模式與 Shell 命令注入防護完整指南（2026）</h1>
        <div class="article-meta">
          <span class="date">2026-02-18</span>
          <span class="reading-time">7 分鐘閱讀</span>
          <div class="tags"><span class="tag">技術研究</span><span class="tag">正規表達式安全</span><span class="tag">命令注入防護</span><span class="tag">Python</span><span class="tag">ReDoS</span><span class="tag">Shell安全</span><span class="tag">Hook系統</span><span class="tag">daily-digest</span></div>
        </div>
      </div>

      <details class="article-toc" open>
        <summary>目錄</summary>
        <ol>
          <li><a href="#一-技術概述">一、技術概述</a></li><li><a href="#二-shell-命令注入繞過技術全景">二、Shell 命令注入繞過技術全景</a></li>  <li><a href="#2-1-子-shell-命令替換">2.1 子 Shell 命令替換</a></li>  <li><a href="#2-2-base64-編碼繞過">2.2 Base64 編碼繞過</a></li>  <li><a href="#2-3-十六進位與八進位編碼">2.3 十六進位與八進位編碼</a></li>  <li><a href="#2-4-引號與空白字元繞過">2.4 引號與空白字元繞過</a></li>  <li><a href="#2-5-變數展開技巧">2.5 變數展開技巧</a></li>  <li><a href="#2-6-萬用字元與-glob-模式">2.6 萬用字元與 Glob 模式</a></li><li><a href="#三-正規表達式安全陷阱">三、正規表達式安全陷阱</a></li>  <li><a href="#3-1-redos-正規表達式阻斷服務">3.1 ReDoS（正規表達式阻斷服務）</a></li>  <li><a href="#3-2-正規表達式注入">3.2 正規表達式注入</a></li>  <li><a href="#3-3-常見-python-re-模組陷阱">3.3 常見 Python re 模組陷阱</a></li><li><a href="#四-設計健壯的安全過濾器">四、設計健壯的安全過濾器</a></li>  <li><a href="#4-1-白名單優於黑名單">4.1 白名單優於黑名單</a></li>  <li><a href="#4-2-多層防禦設計">4.2 多層防禦設計</a></li>  <li><a href="#4-3-正規表達式規則設計原則">4.3 正規表達式規則設計原則</a></li><li><a href="#五-python-命令注入高危函數速查表">五、Python 命令注入高危函數速查表</a></li><li><a href="#六-與-daily-digest-prompt-的應用關聯">六、與 daily-digest-prompt 的應用關聯</a></li>  <li><a href="#6-1-現有-hook-系統的安全設計">6.1 現有 Hook 系統的安全設計</a></li>  <li><a href="#6-2-可改進方向">6.2 可改進方向</a></li>  <li><a href="#6-3-安全規則設計實例">6.3 安全規則設計實例</a></li><li><a href="#七-semgrep-靜態分析規則">七、Semgrep 靜態分析規則</a></li><li><a href="#參考來源">參考來源</a></li>
        </ol>
      </details>

      <div class="article-content">
        <h1>Python 正規表達式安全模式與 Shell 命令注入防護</h1>
<blockquote><p>技術研究 | 2026-02-19 | 與 daily-digest-prompt Hook 安全系統直接相關</p>
</blockquote>
<h2 id="一-技術概述">一、技術概述</h2>
<p>在 AI Agent 系統中，使用正規表達式（Regex）作為安全防護層是一種常見但需要謹慎設計的策略。本文深入研究 Python <code>re</code> 模組的安全最佳實踐，涵蓋：命令注入的繞過技術、正規表達式本身的安全陷阱（ReDoS）、以及如何設計健壯的基於正規表達式的安全過濾器。這對於 daily-digest-prompt 專案的 Hook 系統（pre_bash_guard.py 等）具有直接的實踐價值。</p>
<hr>
<h2 id="二-shell-命令注入繞過技術全景">二、Shell 命令注入繞過技術全景</h2>
<p>攻擊者繞過基於正規表達式的命令過濾器有多種技術，安全防護必須全面了解這些技術才能設計有效的規則。</p>
<h3 id="2-1-子-shell-命令替換">2.1 子 Shell 命令替換</h3>
<pre><code class="language-bash"># 現代語法（POSIX 標準）
$(whoami)
$(cat /etc/passwd)

# 傳統反引號語法
`whoami`
`cat /etc/passwd`

# 空替換插入（繞過關鍵字過濾）
who$()ami        # 等同於 whoami
who$(echo am)i   # 巢狀命令替換</code></pre>
<p><strong>防護要點</strong>：必須偵測 <code>$(</code> 和反引號的存在，且不能僅匹配完整的命令名稱。</p>
<h3 id="2-2-base64-編碼繞過">2.2 Base64 編碼繞過</h3>
<pre><code class="language-bash"># 基本 base64 解碼執行
echo Y2F0IC9ldGMvcGFzc3dk | base64 -d | bash

# 使用 here-string
bash&lt;&lt;&lt;$(base64 -d&lt;&lt;&lt;Y2F0IC9ldGMvcGFzc3dk)

# 變數賦值 + 延遲執行
a=$(echo Y2F0IC9ldGMvcGFzc3dk | base64 -d); eval $a</code></pre>
<p><strong>防護要點</strong>：偵測 <code>base64</code> 關鍵字與 <code>-d</code>（decode）旗標的組合，特別是與管道、bash、eval 搭配時。</p>
<h3 id="2-3-十六進位與八進位編碼">2.3 十六進位與八進位編碼</h3>
<pre><code class="language-bash"># 十六進位
echo -e &quot;\x2f\x65\x74\x63\x2f\x70\x61\x73\x73\x77\x64&quot;
# 輸出 /etc/passwd

# xxd 反向解碼
xxd -r -p &lt;&lt;&lt; 2f6574632f706173737764

# 結合命令替換
cat $(echo -e &quot;\x2f\x65\x74\x63\x2f\x70\x61\x73\x73\x77\x64&quot;)</code></pre>
<h3 id="2-4-引號與空白字元繞過">2.4 引號與空白字元繞過</h3>
<pre><code class="language-bash"># 引號片段化（繞過關鍵字匹配）
w&#x27;h&#x27;o&#x27;am&#x27;i       # 等同 whoami
w&quot;h&quot;o&quot;am&quot;i     # 等同 whoami
wh&#x27;&#x27;oami         # 空引號
w\ho\am\i       # 反斜線

# 空白繞過
cat${IFS}/etc/passwd    # $IFS 替代空白
{cat,/etc/passwd}       # 大括號展開
cat&lt;/etc/passwd         # 輸入重導向
X=$&#x27;cat\x20/etc/passwd&#x27;&amp;&amp;$X  # ANSI-C 引號</code></pre>
<h3 id="2-5-變數展開技巧">2.5 變數展開技巧</h3>
<pre><code class="language-bash"># 從環境變數提取字元
${HOME:0:1}         # 取第一個字元 = /
${PATH:0:1}         # 取第一個字元 = /

# 未初始化變數（空值）
c${u}at /etc/passwd  # $u 為空，結果 = cat /etc/passwd

# 特殊參數
who$@ami             # $@ 展開為空</code></pre>
<h3 id="2-6-萬用字元與-glob-模式">2.6 萬用字元與 Glob 模式</h3>
<pre><code class="language-bash">/???/??t /???/p??s??   # 匹配 /bin/cat /etc/passwd
/???/????m?            # 匹配 /bin/whoami</code></pre>
<hr>
<h2 id="三-正規表達式安全陷阱">三、正規表達式安全陷阱</h2>
<h3 id="3-1-redos-正規表達式阻斷服務">3.1 ReDoS（正規表達式阻斷服務）</h3>
<p>ReDoS 利用正規表達式引擎的回溯（backtracking）機制，透過精心構造的輸入使匹配時間呈指數級增長。</p>
<p><strong>危險模式（Evil Regex）</strong>：</p>
<pre><code class="language-python"># 巢狀量詞
(a+)+$          # 對 &quot;aaaaaaaX&quot; 觸發指數回溯
([a-zA-Z]+)*$   # 同樣危險
(a|aa)+$        # 交替 + 重複
(a|a?)+$        # 可選 + 重複</code></pre>
<p><strong>根因</strong>：NFA 引擎在匹配失敗時逐一嘗試所有可能路徑。例如 <code>(a+)+$</code> 匹配 <code>aaaaX</code> 時需嘗試 16 條路徑，20 個 <code>a</code> 則需 1,048,576 條路徑。</p>
<p><strong>防護原則</strong>：</p>
<pre><code class="language-python">import re

# 壞：巢狀量詞
pattern_bad = re.compile(r&#x27;(a+)+&#x27;)

# 好：展平量詞
pattern_good = re.compile(r&#x27;a+&#x27;)

# 好：使用 possessive quantifiers（Python 3.11+）
pattern_atomic = re.compile(r&#x27;a++&#x27;)  # 不回溯

# 好：限制輸入長度
def safe_match(pattern, text, max_len=10000):
    if len(text) &gt; max_len:
        return None
    return re.match(pattern, text)</code></pre>
<h3 id="3-2-正規表達式注入">3.2 正規表達式注入</h3>
<pre><code class="language-python"># 危險：將使用者輸入直接嵌入正規表達式
user_input = &quot;(.*)+$&quot;  # 惡意 ReDoS 模式
re.match(user_input, target)  # 可能導致 CPU 耗盡

# 安全：使用 re.escape()
safe_pattern = re.escape(user_input)
re.match(safe_pattern, target)</code></pre>
<h3 id="3-3-常見-python-re-模組陷阱">3.3 常見 Python re 模組陷阱</h3>
<pre><code class="language-python"># 陷阱 1：re.match 只匹配字串開頭
re.match(r&#x27;evil&#x27;, &#x27;safe_evil&#x27;)  # None（不匹配）
re.search(r&#x27;evil&#x27;, &#x27;safe_evil&#x27;) # 匹配！

# 陷阱 2：re.DOTALL 改變 . 的行為
re.search(r&#x27;a.*b&#x27;, &#x27;a\nb&#x27;)          # None（. 不匹配 \n）
re.search(r&#x27;a.*b&#x27;, &#x27;a\nb&#x27;, re.DOTALL) # 匹配

# 陷阱 3：多行模式改變 ^ $ 的行為
re.search(r&#x27;^evil$&#x27;, &#x27;safe\nevil&#x27;)              # None
re.search(r&#x27;^evil$&#x27;, &#x27;safe\nevil&#x27;, re.MULTILINE) # 匹配！

# 陷阱 4：Unicode 字元類差異
re.search(r&#x27;\w+&#x27;, &#x27;中文&#x27;)     # 匹配！（Python 3 預設 Unicode）
re.search(r&#x27;[a-zA-Z]+&#x27;, &#x27;中文&#x27;) # None（明確限定 ASCII）</code></pre>
<hr>
<h2 id="四-設計健壯的安全過濾器">四、設計健壯的安全過濾器</h2>
<h3 id="4-1-白名單優於黑名單">4.1 白名單優於黑名單</h3>
<pre><code class="language-python">import re

# 壞：黑名單模式（永遠不完整）
BLACKLIST = re.compile(r&#x27;(rm|cat|wget|curl)&#x27;, re.IGNORECASE)

# 好：白名單模式（只允許已知安全的命令）
WHITELIST = re.compile(r&#x27;^(ls|pwd|echo|date)$&#x27;)

def validate_command(cmd):
    parts = cmd.split()
    if not parts:
        return False
    return bool(WHITELIST.match(parts[0]))</code></pre>
<h3 id="4-2-多層防禦設計">4.2 多層防禦設計</h3>
<pre><code class="language-python"># 第一層：結構化命令執行（最佳）
import subprocess
subprocess.run([&quot;ls&quot;, &quot;-l&quot;, user_input])  # 不經過 shell

# 第二層：引數跳脫（次佳）
import shlex
subprocess.run(f&quot;ls -l {shlex.quote(user_input)}&quot;, shell=True)

# 第三層：正規表達式驗證（補充）
if not re.match(r&#x27;^[a-zA-Z0-9_\-./]+$&#x27;, user_input):
    raise ValueError(&quot;Invalid input&quot;)

# 第四層：輸入長度限制
if len(user_input) &gt; 256:
    raise ValueError(&quot;Input too long&quot;)</code></pre>
<h3 id="4-3-正規表達式規則設計原則">4.3 正規表達式規則設計原則</h3>
<p>基於 daily-digest-prompt Hook 系統的實踐經驗：</p>
<ol>
<li><strong>寧可漏放、不可誤殺</strong>：安全規則應精確匹配已知危險模式，避免寬泛匹配導致合法操作被攔截</li>
<li><strong>排除列表與匹配列表並行</strong>：先匹配危險模式，再排除已知安全操作（如 ls、cat、grep 對特定檔案的讀取）</li>
<li><strong>負向前瞻精確排除</strong>：<code>(?!pattern)</code> 用於排除特定變體，例如 <code>.env(?!\.example|\.sample|\.template)</code> 排除範例檔</li>
<li><strong>分層匹配而非單一正規表達式</strong>：複雜規則拆分為多個簡單正規表達式，提升可讀性和可維護性</li>
<li><strong>Fallback 規則與 YAML 規則同步</strong>：外部化規則從 YAML 載入，Python 中保留硬編碼 fallback，兩者必須行為一致</li>
<li><strong>測試驅動</strong>：每條規則都有對應的 should_block 和 should_allow 測試案例</li>
</ol>
<hr>
<h2 id="五-python-命令注入高危函數速查表">五、Python 命令注入高危函數速查表</h2>
<table>
<tr><th>函數</th><th>風險等級</th><th>安全替代</th></tr>
<tr><td><code>os.system()</code></td><td>極高</td><td><code>subprocess.run([...])</code></td></tr>
<tr><td><code>os.popen()</code></td><td>極高</td><td><code>subprocess.run([...], capture_output=True)</code></td></tr>
<tr><td><code>subprocess.call(..., shell=True)</code></td><td>高</td><td>移除 shell=True，用列表傳參</td></tr>
<tr><td><code>subprocess.Popen(..., shell=True)</code></td><td>高</td><td>同上</td></tr>
<tr><td><code>eval()</code></td><td>極高</td><td><code>ast.literal_eval()</code> 或結構化解析</td></tr>
<tr><td><code>exec()</code></td><td>極高</td><td>避免使用，改用安全的 API</td></tr>
<tr><td><code>asyncio.create_subprocess_shell()</code></td><td>高</td><td>改用 <code>create_subprocess_exec()</code></td></tr>
<tr><td><code>os.exec*()</code></td><td>高</td><td>固定命令 + 列表引數</td></tr>
</table>
<hr>
<h2 id="六-與-daily-digest-prompt-的應用關聯">六、與 daily-digest-prompt 的應用關聯</h2>
<h3 id="6-1-現有-hook-系統的安全設計">6.1 現有 Hook 系統的安全設計</h3>
<p>專案的 hooks/pre_bash_guard.py 採用了多項本文描述的最佳實踐：</p>
<ul>
<li><strong>YAML 規則外部化</strong>：config/hook-rules.yaml 定義 20 條規則（bash 13 + write 4 + read 3），支援 3 個 preset</li>
<li><strong>子 Shell 繞過防護</strong>（2026-02-19 新增）：偵測 <code>$(</code> 和反引號中包含 curl、wget 等敏感命令</li>
<li><strong>Base64 編碼外洩防護</strong>（2026-02-19 新增）：偵測 base64 + -d 與管道或子 Shell 的組合</li>
<li><strong>控制流防禦性修正</strong>：三個 guard hook 的 main() 函數中加上 return 防止控制流穿透</li>
</ul>
<h3 id="6-2-可改進方向">6.2 可改進方向</h3>
<ol>
<li><strong>ReDoS 防護</strong>：對 hook-rules.yaml 中的正規表達式進行 ReDoS 靜態分析，確保無巢狀量詞</li>
<li><strong>十六進位編碼防護</strong>：新增偵測 <code>echo -e &quot;\x..&quot;</code> 和 xxd 的規則</li>
<li><strong>IFS 變數繞過防護</strong>：偵測 <code>${IFS}</code> 在命令中的使用</li>
<li><strong>引號片段化防護</strong>：偵測異常的引號模式（如 w&#x27;h&#x27;o&#x27;am&#x27;i）</li>
<li><strong>regexploit 整合</strong>：使用 Doyensec 的 regexploit 工具掃描所有 hook 規則中的 ReDoS 風險</li>
</ol>
<h3 id="6-3-安全規則設計實例">6.3 安全規則設計實例</h3>
<pre><code class="language-python">import re

# 現有規則：偵測子 Shell 中的外洩命令
SUBSHELL_PATTERN = re.compile(
    r&#x27;[`].*?(curl|wget|nc|ncat)[`]|&#x27;
    r&#x27;\$\(.*?(curl|wget|nc|ncat)&#x27;,
    re.IGNORECASE
)

# 建議新增：十六進位編碼偵測
HEX_EVASION_PATTERN = re.compile(
    r&#x27;echo\s+-e\s+[&quot;\&#x27;].*\\x[0-9a-fA-F]{2}|&#x27;
    r&#x27;xxd\s+-r&#x27;,
    re.IGNORECASE
)

# 建議新增：IFS 繞過偵測
IFS_BYPASS_PATTERN = re.compile(
    r&#x27;\$\{?IFS\}?.*?(curl|wget|cat|rm)&#x27;,
    re.IGNORECASE
)</code></pre>
<hr>
<h2 id="七-semgrep-靜態分析規則">七、Semgrep 靜態分析規則</h2>
<p>Semgrep 提供的 Python 命令注入偵測規則可整合到 CI/CD：</p>
<ul>
<li><code>python.lang.security.audit.dangerous-subprocess-use</code></li>
<li><code>python.lang.security.audit.subprocess-shell-true</code></li>
<li><code>python.lang.security.audit.dangerous-system-call</code></li>
<li><code>python.lang.security.audit.dangerous-spawn-process</code></li>
<li><code>python.lang.security.audit.system-wildcard-detected</code></li>
<li><code>python.lang.security.audit.dangerous-asyncio-shell</code></li>
</ul>
<hr>
<h2 id="參考來源">參考來源</h2>
<ol>
<li>Snyk - Command Injection in Python: Examples and Prevention</li>
<li>OWASP - Regular Expression Denial of Service (ReDoS)</li>
<li>PayloadsAllTheThings - Command Injection Cheatsheet (SwisskyRepo)</li>
<li>Semgrep - Python Command Injection Cheat Sheet</li>
<li>Doyensec - regexploit: Find ReDoS vulnerable patterns</li>
<li>CodeQL - Regular Expression Injection</li>
<li>GuardRails - Insecure Use of Regular Expressions</li>
</ol>
<hr>
<p><em>研究日期：2026-02-19</em>
<em>研究類型：每日技術研究（tech_research）</em>
<em>關聯任務：Hook 安全加固（子Shell/Base64外洩防護 + 控制流防禦）</em></p>

      </div>

      <nav class="article-nav"><a href="claude-code-cicd-整合與-headless-380fd658.html" class="nav-prev"><span class="nav-label">&larr; 上一篇</span><span class="nav-title">Claude Code CI/CD 整合與 Headless 自動化完整指南 — GitHub Actions、非互動式批次執行與持續整合管線最佳實踐（2026）</span></a><a href="hook-安全優化子-shell-繞過防護-base6-f75b2e97.html" class="nav-next"><span class="nav-label">下一篇 &rarr;</span><span class="nav-title">Hook 安全優化：子 Shell 繞過防護 + Base64 編碼外洩防護 + 控制流防禦性修正 (2026-02-19)</span></a></nav>

      <a href="../" class="back-link">&larr; 返回首頁</a>
    </article>
  </main>

  <button class="back-to-top" id="backToTop" onclick="window.scrollTo({top:0,behavior:'smooth'})" aria-label="回到頂部">&uarr;</button>

  <footer>
    <div class="container">
      <p>Powered by RAG Knowledge Base</p>
    </div>
  </footer>
  <script>
    function toggleTheme(){const b=document.body;b.classList.toggle('dark');localStorage.setItem('theme',b.classList.contains('dark')?'dark':'light')}
    if(localStorage.getItem('theme')==='dark')document.body.classList.add('dark');
    window.addEventListener('scroll',function(){
      const prog=document.getElementById('readingProgress');
      const btn=document.getElementById('backToTop');
      const h=document.documentElement.scrollHeight-window.innerHeight;
      const pct=h>0?(window.scrollY/h)*100:0;
      prog.style.width=pct+'%';
      btn.classList.toggle('visible',window.scrollY>300);
    });
  </script>
</body>
</html>
