<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Claude Code CI/CD 整合與 Headless 自動化完整指南 — GitHub Actions、非互動式批次執行與持續整合管線最佳實踐（2026）">
  <title>Claude Code CI/CD 整合與 Headless 自動化完整指南 — GitHub Actions、非互動式批次執行與持續整合管線最佳實踐（2026） | 知識庫</title>
  <link rel="stylesheet" href="../styles.css">
</head>
<body>
  <div class="reading-progress" id="readingProgress"></div>
  <header>
    <div class="container">
      <a href="../" class="logo">知識庫</a>
      <nav>
        <a href="../#buddhism">佛學</a>
        <a href="../#thinking">思維方法</a>
        <a href="../#ai">AI技術</a>
        <a href="../#claude">Claude Code</a>
        <a href="../#game">遊戲</a>
      </nav>
      <button class="theme-toggle" onclick="toggleTheme()" aria-label="切換深色模式">
        <span class="theme-icon">&#9680;</span>
      </button>
    </div>
  </header>

  <main class="container">
    <article>
      <div class="article-header">
        <span class="category-badge category-claude">Claude Code</span>
        <h1>Claude Code CI/CD 整合與 Headless 自動化完整指南 — GitHub Actions、非互動式批次執行與持續整合管線最佳實踐（2026）</h1>
        <div class="article-meta">
          <span class="date">2026-02-19</span>
          <span class="reading-time">8 分鐘閱讀</span>
          <div class="tags"><span class="tag">Claude Code</span><span class="tag">CI/CD</span><span class="tag">GitHub Actions</span><span class="tag">自動化</span><span class="tag">Headless</span><span class="tag">DevOps</span><span class="tag">技術研究</span><span class="tag">2026</span></div>
        </div>
      </div>

      <details class="article-toc" open>
        <summary>目錄</summary>
        <ol>
          <li><a href="#主題概述">主題概述</a></li><li><a href="#一-核心非互動式執行模式">一、核心非互動式執行模式</a></li>  <li><a href="#1-1-print-mode-claude-p">1.1 Print Mode（claude -p）</a></li>  <li><a href="#1-2-json-輸出格式">1.2 JSON 輸出格式</a></li>  <li><a href="#1-3-串流-json-stream-json">1.3 串流 JSON（Stream JSON）</a></li><li><a href="#二-github-actions-官方整合">二、GitHub Actions 官方整合</a></li>  <li><a href="#2-1-anthropics-claude-code-action">2.1 anthropics/claude-code-action</a></li>  <li><a href="#2-2-典型-ci-cd-使用場景">2.2 典型 CI/CD 使用場景</a></li>  <li><a href="#2-3-安全性考量">2.3 安全性考量</a></li><li><a href="#三-claude-code-sdk-程式化呼叫">三、Claude Code SDK 程式化呼叫</a></li>  <li><a href="#3-1-typescript-sdk">3.1 TypeScript SDK</a></li>  <li><a href="#3-2-python-sdk">3.2 Python SDK</a></li><li><a href="#四-進階-ci-cd-模式">四、進階 CI/CD 模式</a></li>  <li><a href="#4-1-多階段管線-pipeline-stages">4.1 多階段管線（Pipeline Stages）</a></li>  <li><a href="#4-2-背景任務-background-tasks">4.2 背景任務（Background Tasks）</a></li>  <li><a href="#4-3-hooks-整合-ci-環境">4.3 Hooks 整合 CI 環境</a></li>  <li><a href="#4-4-條件式觸發與成本優化">4.4 條件式觸發與成本優化</a></li><li><a href="#五-windows-排程器整合實踐">五、Windows 排程器整合實踐</a></li>  <li><a href="#5-1-windows-task-scheduler-powershell">5.1 Windows Task Scheduler + PowerShell</a></li>  <li><a href="#5-2-多-agent-並行管線">5.2 多 Agent 並行管線</a></li><li><a href="#六-最佳實踐與常見陷阱">六、最佳實踐與常見陷阱</a></li>  <li><a href="#最佳實踐">最佳實踐</a></li>  <li><a href="#常見陷阱">常見陷阱</a></li><li><a href="#七-與其他-ci-cd-平台整合">七、與其他 CI/CD 平台整合</a></li>  <li><a href="#gitlab-ci">GitLab CI</a></li>  <li><a href="#jenkins-pipeline">Jenkins Pipeline</a></li><li><a href="#參考來源">參考來源</a></li>
        </ol>
      </details>

      <div class="article-content">
        <h1>Claude Code CI/CD 整合與 Headless 自動化完整指南（2026）</h1>
<h2 id="主題概述">主題概述</h2>
<p>Claude Code 不僅是互動式終端 AI 編程助手，更是一個功能完整的 CI/CD 自動化引擎。透過 <code>claude -p</code>（print mode）旗標，Claude Code 可以完全在非互動式環境中運行，無需人工介入即可完成程式碼審查、自動修復、測試生成、PR 處理等任務。Anthropic 在 2025-2026 年間持續強化 Claude Code 的 CI/CD 整合能力，包括官方 GitHub Action（<code>anthropics/claude-code-action</code>）、Claude Code SDK 的程式化呼叫介面、以及 Background Tasks 背景任務功能。這些特性讓 Claude Code 成為 DevOps 管線中的一等公民，可直接嵌入 GitHub Actions、Jenkins、GitLab CI 等 CI/CD 平台。</p>
<hr>
<h2 id="一-核心非互動式執行模式">一、核心非互動式執行模式</h2>
<h3>1.1 Print Mode（<code>claude -p</code>）</h3>
<p><code>claude -p</code> 是 Claude Code 的非互動式核心，接受 stdin 或命令列參數作為 prompt，執行完畢後直接輸出結果並退出，不進入交互式 REPL。</p>
<p><strong>基本語法：</strong></p>
<pre><code class="language-bash"># 直接傳入 prompt
claude -p &quot;解釋這個函數的功能&quot; --allowedTools &quot;Read,Bash&quot;

# 從 stdin 讀取（管線組合）
cat error.log | claude -p &quot;分析這個錯誤日誌並建議修復方案&quot;

# 指定輸出格式
claude -p &quot;列出所有 TODO 註解&quot; --output-format json</code></pre>
<p><strong>關鍵旗標：</strong></p>
<table>
<tr><th>旗標</th><th>用途</th><th>CI/CD 適用場景</th></tr>
<tr><td><code>-p, --print</code></td><td>非互動式模式（prompt → 輸出 → 退出）</td><td>所有自動化場景</td></tr>
<tr><td><code>--allowedTools</code></td><td>限制可用工具（白名單）</td><td>安全控制，僅開放需要的工具</td></tr>
<tr><td><code>--disallowedTools</code></td><td>禁用特定工具（黑名單）</td><td>防止 CI 中執行危險操作</td></tr>
<tr><td><code>--output-format json</code></td><td>JSON 結構化輸出</td><td>後續管線解析</td></tr>
<tr><td><code>--output-format stream-json</code></td><td>串流 JSON 輸出</td><td>即時進度監控</td></tr>
<tr><td><code>--max-turns N</code></td><td>限制最大對話輪次</td><td>防止無限迴圈，控制成本</td></tr>
<tr><td><code>--model</code></td><td>指定模型</td><td>選擇 opus/sonnet 平衡成本與品質</td></tr>
<tr><td><code>--verbose</code></td><td>詳細輸出</td><td>CI 除錯</td></tr>
</table>
<h3 id="1-2-json-輸出格式">1.2 JSON 輸出格式</h3>
<p><code>--output-format json</code> 回傳結構化資料，方便 CI 管線解析：</p>
<pre><code class="language-json">{
  &quot;type&quot;: &quot;result&quot;,
  &quot;subtype&quot;: &quot;success&quot;,
  &quot;cost_usd&quot;: 0.042,
  &quot;is_error&quot;: false,
  &quot;duration_ms&quot;: 12500,
  &quot;duration_api_ms&quot;: 8200,
  &quot;num_turns&quot;: 3,
  &quot;result&quot;: &quot;修復完成：已更新 3 個檔案...&quot;,
  &quot;session_id&quot;: &quot;abc123&quot;
}</code></pre>
<h3 id="1-3-串流-json-stream-json">1.3 串流 JSON（Stream JSON）</h3>
<p><code>--output-format stream-json</code> 在執行過程中即時輸出事件，適合長時間任務的進度監控：</p>
<pre><code class="language-plaintext">{&quot;type&quot;:&quot;assistant&quot;,&quot;message&quot;:{&quot;content&quot;:[{&quot;type&quot;:&quot;text&quot;,&quot;text&quot;:&quot;正在分析...&quot;}]}}
{&quot;type&quot;:&quot;tool_use&quot;,&quot;tool&quot;:{&quot;name&quot;:&quot;Read&quot;,&quot;input&quot;:{&quot;file_path&quot;:&quot;src/main.py&quot;}}}
{&quot;type&quot;:&quot;result&quot;,&quot;subtype&quot;:&quot;success&quot;,&quot;result&quot;:&quot;分析完成&quot;}</code></pre>
<hr>
<h2 id="二-github-actions-官方整合">二、GitHub Actions 官方整合</h2>
<h3 id="2-1-anthropics-claude-code-action">2.1 anthropics/claude-code-action</h3>
<p>Anthropic 提供官方 GitHub Action <code>anthropics/claude-code-action</code>，可直接在 GitHub workflow 中執行 Claude Code。</p>
<p><strong>基本 workflow 範例：</strong></p>
<pre><code class="language-yaml">name: Claude Code Review
on:
  pull_request:
    types: [opened, synchronize]
  issues:
    types: [opened, labeled]
  issue_comment:
    types: [created]

jobs:
  claude-review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: anthropics/claude-code-action@beta
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          # 可選配置
          model: &quot;claude-sonnet-4-20250514&quot;  # 成本優化用 Sonnet
          max_turns: 10
          allowed_tools: &quot;Read,Bash,Write,Edit&quot;  # 工具白名單
          custom_instructions: &quot;請用繁體中文回覆&quot;</code></pre>
<h3 id="2-2-典型-ci-cd-使用場景">2.2 典型 CI/CD 使用場景</h3>
<p>#### 場景 A：自動 PR 審查</p>
<pre><code class="language-yaml">- uses: anthropics/claude-code-action@beta
  with:
    anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
    trigger_phrase: &quot;/review&quot;
    direct_prompt: |
      審查此 PR 的程式碼變更：
      1. 檢查是否有安全漏洞
      2. 評估程式碼品質
      3. 建議改善方案</code></pre>
<p>#### 場景 B：自動修復 Lint 錯誤</p>
<pre><code class="language-yaml">- name: Run linter
  run: npm run lint 2&gt; lint-errors.txt || true
- uses: anthropics/claude-code-action@beta
  with:
    anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
    direct_prompt: |
      讀取 lint-errors.txt 並自動修復所有 lint 錯誤。
      修復後確認 npm run lint 通過。</code></pre>
<p>#### 場景 C：Issue 自動分類與回應</p>
<pre><code class="language-yaml">on:
  issues:
    types: [opened]
jobs:
  triage:
    runs-on: ubuntu-latest
    steps:
      - uses: anthropics/claude-code-action@beta
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          direct_prompt: |
            分析此 issue，進行以下操作：
            1. 判斷是 bug/feature/question
            2. 加上對應的 label
            3. 如果是 bug，嘗試定位相關程式碼</code></pre>
<h3 id="2-3-安全性考量">2.3 安全性考量</h3>
<ul>
<li><strong>API Key 管理</strong>：使用 GitHub Secrets 儲存 <code>ANTHROPIC_API_KEY</code>，切勿硬編碼</li>
<li><strong>工具白名單</strong>：CI 環境中嚴格限制 <code>allowed_tools</code>，避免不必要的檔案寫入或 shell 執行</li>
<li><strong>分支保護</strong>：設定 branch protection rules，Claude 的修改仍需通過 CI 檢查</li>
<li><strong>成本控制</strong>：使用 <code>max_turns</code> 限制對話輪次，避免無限迴圈消耗 API credit</li>
<li><strong>審計日誌</strong>：啟用 <code>--output-format json</code> 記錄每次執行的成本與結果</li>
</ul>
<hr>
<h2 id="三-claude-code-sdk-程式化呼叫">三、Claude Code SDK 程式化呼叫</h2>
<h3 id="3-1-typescript-sdk">3.1 TypeScript SDK</h3>
<p>Claude Code（現更名 Claude Agent SDK）提供 TypeScript 和 Python SDK，可直接在應用程式中程式化呼叫：</p>
<pre><code class="language-typescript">import { Claude } from &#x27;@anthropic-ai/claude-code&#x27;;

const claude = new Claude();

// 非互動式執行
const result = await claude.run({
  prompt: &#x27;分析 src/ 目錄下所有 TypeScript 檔案的型別錯誤&#x27;,
  allowedTools: [&#x27;Read&#x27;, &#x27;Bash&#x27;],
  maxTurns: 5,
  outputFormat: &#x27;json&#x27;
});

console.log(result.result);  // 分析結果
console.log(result.cost_usd); // 成本追蹤</code></pre>
<h3 id="3-2-python-sdk">3.2 Python SDK</h3>
<pre><code class="language-python">import subprocess
import json

# 方法 1：subprocess 呼叫 CLI
result = subprocess.run(
    [&#x27;claude&#x27;, &#x27;-p&#x27;, &#x27;列出所有未處理的 TODO&#x27;, &#x27;--output-format&#x27;, &#x27;json&#x27;],
    capture_output=True, text=True
)
data = json.loads(result.stdout)

# 方法 2：Claude Agent SDK（Python 套件）
from claude_code import Claude

claude = Claude()
result = claude.run(
    prompt=&quot;執行測試並修復失敗的測試案例&quot;,
    allowed_tools=[&quot;Read&quot;, &quot;Bash&quot;, &quot;Write&quot;, &quot;Edit&quot;],
    max_turns=10
)</code></pre>
<hr>
<h2 id="四-進階-ci-cd-模式">四、進階 CI/CD 模式</h2>
<h3 id="4-1-多階段管線-pipeline-stages">4.1 多階段管線（Pipeline Stages）</h3>
<p>將 Claude Code 嵌入多階段 CI 管線，每階段執行特定任務：</p>
<pre><code class="language-yaml"># Stage 1: 靜態分析
- name: Static Analysis
  run: |
    claude -p &quot;對 src/ 進行安全審查，輸出 JSON 報告&quot; \
      --allowedTools &quot;Read&quot; \
      --output-format json &gt; analysis.json

# Stage 2: 自動修復
- name: Auto Fix
  run: |
    claude -p &quot;根據 analysis.json 的建議自動修復問題&quot; \
      --allowedTools &quot;Read,Write,Edit,Bash&quot; \
      --max-turns 15

# Stage 3: 驗證
- name: Verify
  run: |
    claude -p &quot;確認所有修復已生效，執行測試套件&quot; \
      --allowedTools &quot;Read,Bash&quot; \
      --output-format json &gt; verify.json</code></pre>
<h3 id="4-2-背景任務-background-tasks">4.2 背景任務（Background Tasks）</h3>
<p>對於耗時的自動化任務（如大型程式碼庫掃描），可使用背景執行模式：</p>
<pre><code class="language-bash"># 啟動背景任務
claude -p &quot;掃描整個專案的安全漏洞&quot; --background &amp;
BG_PID=$!

# 同時執行其他 CI 步驟
npm run build
npm run test

# 等待 Claude 完成
wait $BG_PID</code></pre>
<h3 id="4-3-hooks-整合-ci-環境">4.3 Hooks 整合 CI 環境</h3>
<p>Claude Code Hooks 可在 CI 中提供額外的安全防護：</p>
<pre><code class="language-json">// .claude/settings.json
{
  &quot;hooks&quot;: {
    &quot;PreToolUse&quot;: [
      {
        &quot;matcher&quot;: &quot;Bash&quot;,
        &quot;hooks&quot;: [&quot;python hooks/ci_guard.py&quot;]
      }
    ],
    &quot;PostToolUse&quot;: [
      {
        &quot;matcher&quot;: &quot;*&quot;,
        &quot;hooks&quot;: [&quot;python hooks/ci_logger.py&quot;]
      }
    ]
  }
}</code></pre>
<h3 id="4-4-條件式觸發與成本優化">4.4 條件式觸發與成本優化</h3>
<pre><code class="language-yaml"># 僅在特定條件下觸發 Claude
- name: Claude Review (Large PRs only)
  if: github.event.pull_request.changed_files &gt; 5
  run: |
    claude -p &quot;審查此 PR 的 ${{ github.event.pull_request.changed_files }} 個變更檔案&quot; \
      --model claude-sonnet-4-20250514 \
      --max-turns 8</code></pre>
<p><strong>成本優化策略：</strong></p>
<table>
<tr><th>策略</th><th>說明</th><th>預估節省</th></tr>
<tr><td>模型選擇</td><td>簡單任務用 Sonnet，複雜任務用 Opus</td><td>50-70%</td></tr>
<tr><td>max_turns 限制</td><td>設定合理上限（5-15）</td><td>防止失控</td></tr>
<tr><td>條件觸發</td><td>僅大型 PR 或特定標籤觸發</td><td>60-80%</td></tr>
<tr><td>工具限制</td><td>Read-only 模式減少 token 消耗</td><td>20-30%</td></tr>
<tr><td>快取機制</td><td>相同 commit 不重複分析</td><td>30-50%</td></tr>
</table>
<hr>
<h2 id="五-windows-排程器整合實踐">五、Windows 排程器整合實踐</h2>
<h3 id="5-1-windows-task-scheduler-powershell">5.1 Windows Task Scheduler + PowerShell</h3>
<p>本專案（daily-digest-prompt）展示了 Claude Code 在 Windows 環境下的完整自動化實踐：</p>
<pre><code class="language-powershell"># run-agent-team.ps1 — 團隊並行模式
$result = Start-Job -ScriptBlock {
    claude -p (Get-Content &quot;prompt.md&quot; -Raw) `
        --allowedTools &quot;Read,Bash,Write&quot; `
        --output-format json
} -WorkingDirectory $AgentDir

# 等待完成並解析結果
$output = Receive-Job -Job $result -Wait
$data = $output | ConvertFrom-Json</code></pre>
<h3 id="5-2-多-agent-並行管線">5.2 多 Agent 並行管線</h3>
<pre><code class="language-powershell"># Phase 1: 5 路並行擷取
$jobs = @()
$jobs += Start-Job { claude -p (cat fetch-todoist.md) ... }
$jobs += Start-Job { claude -p (cat fetch-news.md) ... }
$jobs += Start-Job { claude -p (cat fetch-hackernews.md) ... }
$jobs += Start-Job { claude -p (cat fetch-gmail.md) ... }
$jobs += Start-Job { claude -p (cat fetch-security.md) ... }

# 等待全部完成
$jobs | Wait-Job -Timeout 300

# Phase 2: 組裝
claude -p (cat assemble-digest.md) --allowedTools &quot;Read,Bash,Write&quot;</code></pre>
<hr>
<h2 id="六-最佳實踐與常見陷阱">六、最佳實踐與常見陷阱</h2>
<h3 id="最佳實踐">最佳實踐</h3>
<ol>
<li><strong>工具最小權限原則</strong>：CI 中永遠使用 <code>--allowedTools</code> 限制工具範圍，審查任務只需 <code>Read</code>，修復任務才開放 <code>Write,Edit</code></li>
<li><strong>結構化輸出</strong>：始終使用 <code>--output-format json</code> 便於後續管線解析和審計</li>
<li><strong>冪等設計</strong>：確保 Claude 的操作是冪等的（重複執行不會產生副作用）</li>
<li><strong>超時防護</strong>：設定 <code>--max-turns</code> 和外部 timeout，雙層防護避免無限執行</li>
<li><strong>成本追蹤</strong>：解析 JSON 輸出中的 <code>cost_usd</code> 欄位，設定每日/每月成本上限告警</li>
<li><strong>失敗重試</strong>：CI 腳本應包含自動重試邏輯（間隔 60-120 秒，最多 2 次）</li>
<li><strong>日誌保留</strong>：將 Claude 的輸出保存為 CI artifact，便於事後審計</li>
</ol>
<h3 id="常見陷阱">常見陷阱</h3>
<ol>
<li><strong>Windows 編碼問題</strong>：Windows Bash 的 inline JSON 會亂碼，必須用檔案方式（<code>-d @file.json</code>）發送 POST 請求</li>
<li><strong>nul 檔案</strong>：Windows bash 中 <code>&gt; nul</code> 會建立實體檔案，必須用 <code>&gt; /dev/null 2&gt;&amp;1</code></li>
<li><strong>API Rate Limiting</strong>：並行 Agent 過多可能觸發 API 速率限制，建議 5 個以下</li>
<li><strong>Context Window 溢出</strong>：大型專案的 <code>claude -p</code> 可能耗盡 context window，用 <code>--max-turns</code> 控制</li>
<li><strong>Secrets 洩露</strong>：確保 Hooks 攔截敏感環境變數的 echo/printenv 操作</li>
</ol>
<hr>
<h2 id="七-與其他-ci-cd-平台整合">七、與其他 CI/CD 平台整合</h2>
<h3 id="gitlab-ci">GitLab CI</h3>
<pre><code class="language-yaml">claude-review:
  stage: review
  script:
    - claude -p &quot;審查 MR 變更&quot; --allowedTools Read --output-format json &gt; review.json
  artifacts:
    paths: [review.json]</code></pre>
<h3 id="jenkins-pipeline">Jenkins Pipeline</h3>
<pre><code class="language-groovy">pipeline {
    stages {
        stage(&#x27;AI Review&#x27;) {
            steps {
                sh &#x27;claude -p &quot;審查最近的 commit&quot; --output-format json &gt; review.json&#x27;
                archiveArtifacts &#x27;review.json&#x27;
            }
        }
    }
}</code></pre>
<hr>
<h2 id="參考來源">參考來源</h2>
<ol>
<li>Anthropic 官方文件 — Claude Code CLI Usage（docs.anthropic.com/en/docs/claude-code/cli-usage）</li>
<li>Anthropic 官方文件 — Claude Code GitHub Actions（docs.anthropic.com/en/docs/claude-code/github-actions）</li>
<li>GitHub — anthropics/claude-code-action 官方 Action 倉庫</li>
<li>Anthropic Blog — Introducing Claude Code: AI pair programming in the terminal</li>
<li>Anthropic 官方文件 — Claude Code Hooks（docs.anthropic.com/en/docs/claude-code/hooks）</li>
<li>daily-digest-prompt 專案實踐 — Windows Task Scheduler + 多 Agent 並行管線</li>
</ol>
<hr>
<p><em>研究日期：2026-02-19</em>
<em>研究者：Claude Code Agent</em>
<em>任務類型：todoist_research（Claude Code 技術研究）</em>
<em>研究方向：CI/CD 整合與 Headless 自動化</em></p>

      </div>

      <nav class="article-nav"><a href="ai-assisted-coding-最佳實踐copilo-ae2404f5.html" class="nav-prev"><span class="nav-label">&larr; 上一篇</span><span class="nav-title">AI-Assisted Coding 最佳實踐：Copilot、Cursor、Claude Code 工作流與 Prompt Engineering for Code（2026）</span></a><a href="python-正規表達式安全模式與-shell-命令注入防護-020b2eeb.html" class="nav-next"><span class="nav-label">下一篇 &rarr;</span><span class="nav-title">Python 正規表達式安全模式與 Shell 命令注入防護完整指南（2026）</span></a></nav>

      <a href="../" class="back-link">&larr; 返回首頁</a>
    </article>
  </main>

  <button class="back-to-top" id="backToTop" onclick="window.scrollTo({top:0,behavior:'smooth'})" aria-label="回到頂部">&uarr;</button>

  <footer>
    <div class="container">
      <p>Powered by RAG Knowledge Base</p>
    </div>
  </footer>
  <script>
    function toggleTheme(){const b=document.body;b.classList.toggle('dark');localStorage.setItem('theme',b.classList.contains('dark')?'dark':'light')}
    if(localStorage.getItem('theme')==='dark')document.body.classList.add('dark');
    window.addEventListener('scroll',function(){
      const prog=document.getElementById('readingProgress');
      const btn=document.getElementById('backToTop');
      const h=document.documentElement.scrollHeight-window.innerHeight;
      const pct=h>0?(window.scrollY/h)*100:0;
      prog.style.width=pct+'%';
      btn.classList.toggle('visible',window.scrollY>300);
    });
  </script>
</body>
</html>
