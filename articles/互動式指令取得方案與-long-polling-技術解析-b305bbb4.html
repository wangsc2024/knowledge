<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="互動式指令取得方案與 Long-Polling 技術解析">
  <title>互動式指令取得方案與 Long-Polling 技術解析 | 知識庫</title>
  <link rel="stylesheet" href="../styles.css">
</head>
<body>
  <header>
    <div class="container">
      <a href="../" class="logo">知識庫</a>
      <nav>
        <a href="../#buddhism">佛學</a>
        <a href="../#thinking">思維方法</a>
        <a href="../#ai">AI技術</a>
        <a href="../#claude">Claude Code</a>
      </nav>
    </div>
  </header>

  <main class="container">
    <article>
      <div class="article-header">
        <span class="category-badge category-claude">Claude_Code</span>
        <h1>互動式指令取得方案與 Long-Polling 技術解析</h1>
        <div class="article-meta">
          <div class="tags"><span class="tag">互動式指令</span><span class="tag">long-polling</span><span class="tag">ntfy</span><span class="tag">telegram-bot</span><span class="tag">claude-code-hooks</span><span class="tag">todoist-webhook</span></div>
        </div>
      </div>

      <div class="article-content">
        <h1>互動式指令取得方案與 Long-Polling 技術解析</h1>
<h2>摘要</h2>
<p>本文整理 Daily Digest Prompt 專案在「定時輪詢 Todoist」之外，可採用的互動式指令取得方案。涵蓋 9 種方案的評估，深入介紹前 4 名推薦方案及 Claude Code Hooks 與 Todoist 整合，並以完整圖解說明 Long-Polling 通訊機制。</p>
<hr>
<h2>一、問題背景</h2>
<h3>現有架構的限制</h3>
<p>目前專案唯一的指令來源是 Windows Task Scheduler 定時輪詢 Todoist（每小時一次，09:00-22:00）。</p>
<p>兩個根本限制：</p>
<ol>
<li><strong>延遲高</strong>：最長需等 59 分鐘才會被處理</li>
<li><strong>單向性</strong>：只能被動等待排程觸發，無法即時互動</li>
</ol>
<h3>已有基礎設施</h3>
<ul>
<li>ntfy.sh（推播通知，topic: wangsc2025）</li>
<li>Gmail OAuth2</li>
<li>Todoist REST API v1</li>
<li>PowerShell 執行環境</li>
<li>Claude Code CLI（claude -p）</li>
</ul>
<hr>
<h2>二、9 種方案總覽</h2>
<table>
<tr><th>#</th><th>方案</th><th>複雜度</th><th>延遲</th><th>手機可用</th><th>無需公開 URL</th><th>推薦度</th></tr>
<tr><td>1</td><td>ntfy 雙向通訊</td><td>低</td><td>1-3s</td><td>是</td><td>是</td><td>★★★★★</td></tr>
<tr><td>2</td><td>Telegram Bot</td><td>中</td><td>1-2s</td><td>是</td><td>是</td><td>★★★★☆</td></tr>
<tr><td>3</td><td>檔案監控 + 雲端同步</td><td>低-中</td><td>5-60s</td><td>是</td><td>是</td><td>★★★☆☆</td></tr>
<tr><td>4</td><td>Todoist Webhook</td><td>中-高</td><td>&lt;1s</td><td>是</td><td>否</td><td>★★★☆☆</td></tr>
<tr><td>5</td><td>n8n 自架</td><td>中</td><td>1-3s</td><td>透過網頁</td><td>是</td><td>★★★☆☆</td></tr>
<tr><td>6</td><td>Claude Code Hooks</td><td>低</td><td>N/A</td><td>否</td><td>是</td><td>★★★☆☆</td></tr>
<tr><td>7</td><td>Email 觸發</td><td>中</td><td>1-15min</td><td>是</td><td>是</td><td>★★☆☆☆</td></tr>
<tr><td>8</td><td>Web 儀表板</td><td>高</td><td>1-2s</td><td>是</td><td>是</td><td>★★☆☆☆</td></tr>
<tr><td>9</td><td>語音介面</td><td>中-高</td><td>2-5s</td><td>否</td><td>是</td><td>★☆☆☆☆</td></tr>
</table>
<hr>
<h2>三、方案 1：ntfy 雙向通訊（最推薦）</h2>
<h3>核心概念</h3>
<p>專案已用 ntfy 做單向推播（Agent → 手機）。ntfy 同時支援訂閱功能，可反向使用（手機 → Agent），形成雙向指令通道。</p>
<h3>架構</h3>
<p>兩個 topic 形成閉環：</p>
<ul>
<li>wangsc2025-cmd：指令頻道（手機 → 電腦）</li>
<li>wangsc2025：通知頻道（電腦 → 手機，已有）</li>
</ul>
<h3>ntfy 訂閱方式</h3>
<ul>
<li>CLI 訂閱：ntfy subscribe topic &quot;command&quot; — 最簡單</li>
<li>JSON 串流：curl -s ntfy.sh/topic/json — 持續連線</li>
<li>WebSocket：ntfy.sh/topic/ws — 雙向即時</li>
<li>SSE：ntfy.sh/topic/sse — Server-Sent Events</li>
<li>一次性輪詢：ntfy.sh/topic/json?poll=1&amp;since=30s</li>
</ul>
<h3>指令路由</h3>
<ul>
<li>digest → run-agent-team.ps1（每日摘要）</li>
<li>todoist → run-todoist-agent.ps1（檢查 Todoist）</li>
<li>gmail → run-gmail-agent.ps1（檢查 Gmail）</li>
<li>health → check-health.ps1（系統健康）</li>
<li>status → 讀取 scheduler-state.json</li>
<li>run 自訂 prompt → claude -p &quot;prompt&quot;</li>
</ul>
<h3>安全性三層防護</h3>
<ol>
<li>隨機 topic 名（不易猜中）</li>
<li>訊息 token 前綴驗證</li>
<li>ntfy Access Token 認證</li>
</ol>
<h3>優勢</h3>
<ul>
<li>零新依賴（ntfy 已在用，App 已安裝）</li>
<li>監聽器核心邏輯約 30-50 行 PowerShell</li>
<li>延遲 1-3 秒</li>
<li>不需要公開 URL</li>
</ul>
<hr>
<h2>四、方案 2：Telegram Bot</h2>
<h3>架構</h3>
<p>手機 Telegram App → Telegram Server（Bot 用 long-polling 拉取）→ Windows Bot 程式（Python）→ claude -p → 結果回覆到 Telegram</p>
<h3>關鍵：Long-Polling 不需要公開 URL</h3>
<p>Bot 主動向 Telegram Server 發起 GET 請求拉取訊息，純 outbound 連線，NAT/防火牆不影響。</p>
<h3>現成專案</h3>
<ul>
<li>claude-code-telegram (RichardAtCT)：最完整，會話持久化、內建排程器、串流回應、外掛系統</li>
<li>Claude-Code-Remote (JessyTsui)：支援 Email/Discord/Telegram 多通道</li>
<li>claudecode-telegram (hanxiao)：輕量級 tmux 橋接</li>
</ul>
<h3>ntfy vs Telegram</h3>
<ul>
<li>ntfy：低互動、零依賴、適合快速觸發</li>
<li>Telegram：高互動（按鈕、串流、對話）、會話持久化、適合深度互動</li>
</ul>
<hr>
<h2>五、方案 3：檔案監控 + 雲端同步</h2>
<p>利用 .NET 原生 System.IO.FileSystemWatcher 監控指令資料夾。搭配 OneDrive/Dropbox 即可從任何裝置投遞指令。</p>
<ul>
<li>零外部依賴（.NET 原生）</li>
<li>離線可用</li>
<li>延遲 5-60 秒（受雲端同步影響）</li>
<li>適合作為備援通道</li>
</ul>
<hr>
<h2>六、方案 4：Todoist Webhook + Claude Code Hooks</h2>
<h3>Todoist Webhook</h3>
<p>將「每小時輪詢」升級為「即時事件驅動」。Todoist 在任務變化時即時 POST 到指定 URL。</p>
<p>主要障礙：需要公開 HTTPS 端點（ngrok/Cloudflare Tunnel/n8n）。</p>
<p>可監聽事件：item:added、item:updated、item:completed。</p>
<h3>Claude Code Hooks</h3>
<p>內建生命週期事件系統，5 個 Hook 點：</p>
<ul>
<li>SessionStart：會話開始 → 環境初始化</li>
<li>PreToolUse：工具使用前 → 安全閘門</li>
<li>PostToolUse：工具使用後 → 進度追蹤</li>
<li>Stop：Agent 完成 → 自動通知/關閉任務</li>
<li>Notification：Claude 通知 → 轉發外部通道</li>
</ul>
<h3>整合場景</h3>
<ul>
<li>Stop Hook：自動關閉 Todoist 任務 + 評論 + ntfy 通知</li>
<li>PreToolUse：攔截 rm -rf 等危險操作（exit 2）</li>
<li>PostToolUse：在 Todoist 任務添加進度評論</li>
</ul>
<h3>Hook 資料流</h3>
<p>Claude Code → stdin JSON → Hook Script → exit code → Claude Code（0=繼續，2=攔截）</p>
<h3>定位</h3>
<p>Hooks 是強化任何方案的利器，與方案 1-4 互補而非互斥。</p>
<hr>
<h2>七、Long-Polling 技術解析</h2>
<h3>三種通訊模式</h3>
<p><strong>短輪詢</strong>：客戶端定期詢問「有新訊息嗎？」，伺服器立刻回應。間隔太長延遲高，太短浪費資源。</p>
<p><strong>Long-Polling</strong>：客戶端詢問「有新訊息嗎？」，伺服器「故意不回應」保持連線，直到有新資料才送回。然後客戶端立刻再發下一個請求。</p>
<p><strong>WebSocket</strong>：持久雙向通道，隨時互發訊息。</p>
<h3>Long-Polling 完整流程（Telegram Bot）</h3>
<ol>
<li>Bot 發起 GET /getUpdates?timeout=30（普通 HTTPS outbound 請求）</li>
<li>伺服器持有連線：有訊息立刻回應，無訊息等到 timeout（30秒）回空陣列</li>
<li>Bot 收到回應後立刻再發請求，形成無限迴圈</li>
</ol>
<h3>延遲對比</h3>
<ul>
<li>短輪詢（60分鐘）：平均 30 分鐘延遲，每分鐘 0.017 次請求</li>
<li>短輪詢（5秒）：0-5 秒延遲，每分鐘 12 次請求（浪費）</li>
<li>Long-Polling（30s）：0.1-0.3 秒延遲，每分鐘約 2 次請求（最佳平衡）</li>
<li>WebSocket：&lt; 0.1 秒，0 次輪詢（最低但複雜）</li>
</ul>
<h3>offset 防重複機制</h3>
<p>類似 Kafka consumer offset。Bot 處理完訊息後，下次請求帶 offset = 最後 update_id + 1，伺服器只回傳更新的訊息。</p>
<h3>與 Webhook 的根本差異</h3>
<ul>
<li>Webhook（Push）：伺服器 POST 到你的電腦 → 需要公開 URL、HTTPS、開 port</li>
<li>Long-Polling（Pull）：你的電腦 GET 到伺服器 → 只有 outbound，零暴露</li>
</ul>
<h3>Long-Polling 本質</h3>
<p>客戶端問「有新消息嗎？」，伺服器回答「等一下，有了再告訴你」——然後保持連線直到有消息或超時。用最簡單的 HTTP 請求-回應模型，實現接近即時的推送效果。</p>
<h3>ntfy 的等價物</h3>
<ul>
<li>JSON 串流：curl -s ntfy.sh/topic/json（持久連線）</li>
<li>SSE：curl -s ntfy.sh/topic/sse</li>
<li>短輪詢 + since：curl ntfy.sh/topic/json?poll=1&amp;since=30s</li>
</ul>
<hr>
<h2>八、推薦實施順序</h2>
<table>
<tr><th>階段</th><th>方案</th><th>投入</th><th>效益</th></tr>
<tr><td>1</td><td>ntfy 雙向通訊</td><td>數小時</td><td>即時指令、零新依賴</td></tr>
<tr><td>2</td><td>Claude Code Hooks</td><td>1 小時</td><td>自動通知、安全閘門</td></tr>
<tr><td>3</td><td>Telegram Bot</td><td>1-2 天</td><td>對話式互動、串流回應</td></tr>
<tr><td>4</td><td>n8n 統一編排</td><td>2-3 天</td><td>多觸發源統一管理</td></tr>
</table>
<hr>
<h2>九、五個方案的關係</h2>
<p>方案 1-4 解決「怎麼收指令」（ntfy/Telegram/檔案監控/Todoist Webhook），方案 5 解決「Agent 執行中的自動化」（Claude Code Hooks）。它們互相補充，不互相排斥。</p>
<hr>
<h2>參考資源</h2>
<ul>
<li>ntfy CLI subscribe：https://docs.ntfy.sh/subscribe/cli/</li>
<li>ntfy Subscription API：https://docs.ntfy.sh/subscribe/api/</li>
<li>claude-code-telegram：github.com/RichardAtCT/claude-code-telegram</li>
<li>Claude-Code-Remote：github.com/JessyTsui/Claude-Code-Remote</li>
<li>Claude Code Hooks：code.claude.com/docs/en/hooks-guide</li>
<li>Claude Code Agent SDK：code.claude.com/docs/en/headless</li>
<li>n8n Claude Code 整合：n8n.io/integrations/webhook/and/claude/</li>
</ul>

      </div>

      <a href="../" class="back-link">← 返回首頁</a>
    </article>
  </main>

  <footer>
    <div class="container">
      <p>Powered by RAG Knowledge Base</p>
    </div>
  </footer>
</body>
</html>
