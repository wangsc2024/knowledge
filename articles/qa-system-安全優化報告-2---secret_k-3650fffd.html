<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="QA System 安全優化報告 #2 - SECRET_KEY 環境變數化與 CORS 限制與錯誤洩漏修復">
  <title>QA System 安全優化報告 #2 - SECRET_KEY 環境變數化與 CORS 限制與錯誤洩漏修復 | 知識庫</title>
  <link rel="stylesheet" href="../styles.css">
</head>
<body>
  <div class="reading-progress" id="readingProgress"></div>
  <header>
    <div class="container">
      <a href="../" class="logo">知識庫</a>
      <nav>
        <a href="../#buddhism">佛學</a>
        <a href="../#thinking">思維方法</a>
        <a href="../#ai">AI技術</a>
        <a href="../#claude">Claude Code</a>
        <a href="../#game">遊戲</a>
      </nav>
      <button class="theme-toggle" onclick="toggleTheme()" aria-label="切換深色模式">
        <span class="theme-icon">&#9680;</span>
      </button>
    </div>
  </header>

  <main class="container">
    <article>
      <div class="article-header">
        <span class="category-badge category-security">資訊安全</span>
        <h1>QA System 安全優化報告 #2 - SECRET_KEY 環境變數化與 CORS 限制與錯誤洩漏修復</h1>
        <div class="article-meta">
          <span class="date">2026-02-15</span>
          <span class="reading-time">1 分鐘閱讀</span>
          <div class="tags"><span class="tag">QA System</span><span class="tag">安全優化</span><span class="tag">SECRET_KEY</span><span class="tag">CORS</span><span class="tag">錯誤訊息洩漏</span><span class="tag">品質改善</span></div>
        </div>
      </div>

      <details class="article-toc" open>
        <summary>目錄</summary>
        <ol>
          <li><a href="#優化方向">優化方向</a></li><li><a href="#已修復問題-3-項">已修復問題（3 項）</a></li>  <li><a href="#1-secret_key-硬編碼-嚴重">1. SECRET_KEY 硬編碼（嚴重）</a></li>  <li><a href="#2-cors-允許所有來源-中等">2. CORS 允許所有來源（中等）</a></li>  <li><a href="#3-錯誤訊息洩漏內部資訊-中等">3. 錯誤訊息洩漏內部資訊（中等）</a></li><li><a href="#未修復問題-待後續處理">未修復問題（待後續處理）</a></li><li><a href="#品質趨勢">品質趨勢</a></li>
        </ol>
      </details>

      <div class="article-content">
        <h1>QA System 安全優化報告 #2</h1>
<blockquote><p>日期：2026-02-16 | 品質分數：3/5 | 第二次掃描</p>
</blockquote>
<h2 id="優化方向">優化方向</h2>
<p>SECRET_KEY 環境變數化 + CORS 限制允許來源 + 錯誤訊息洩漏修復（承接第一次掃描的 remaining_issues）</p>
<h2 id="已修復問題-3-項">已修復問題（3 項）</h2>
<h3 id="1-secret_key-硬編碼-嚴重">1. SECRET_KEY 硬編碼（嚴重）</h3>
<ul>
<li><strong>位置</strong>：<code>app/config.py</code> 第 5 行</li>
<li><strong>問題</strong>：SECRET_KEY 直接寫死 <code>2bbd5caa6a996d5ab0d6605c2351455494a33799e3c32365</code></li>
<li><strong>修復</strong>：改用 <code>os.environ.get(&#x27;QA_SECRET_KEY&#x27;, secrets.token_hex(24))</code>，未設定環境變數時自動產生隨機金鑰</li>
</ul>
<h3 id="2-cors-允許所有來源-中等">2. CORS 允許所有來源（中等）</h3>
<ul>
<li><strong>位置</strong>：<code>main.py</code> 第 89-95 行</li>
<li><strong>問題</strong>：<code>allow_origins=[&#x27;*&#x27;]</code> 搭配 <code>allow_credentials=True</code> 允許任何網站發起跨域帶憑證請求</li>
<li><strong>修復</strong>：從環境變數 <code>QA_CORS_ORIGINS</code> 讀取允許來源（預設 <code>http://172.20.11.22:8000</code>），methods 限定 GET/POST/PUT/DELETE，headers 限定 Content-Type 和 Authorization</li>
</ul>
<h3 id="3-錯誤訊息洩漏內部資訊-中等">3. 錯誤訊息洩漏內部資訊（中等）</h3>
<ul>
<li><strong>位置</strong>：<code>main.py</code>（2 處）+ <code>app/routers/auth.py</code>（3 處），共 5 處</li>
<li><strong>問題</strong>：<code>str(soap_error)</code> 和 <code>str(e)</code> 直接顯示在前端，暴露 SOAP 端點 URL、資料庫結構、堆疊追蹤等內部資訊</li>
<li><strong>修復</strong>：前端回應改為通用錯誤訊息（如「SSO 驗證服務暫時無法使用」），詳細錯誤僅記錄到 server-side logger</li>
</ul>
<h2 id="未修復問題-待後續處理">未修復問題（待後續處理）</h2>
<ol>
<li><code>dependencies.py</code> 大量 <code>print()</code> 洩漏用戶名、權限、部門等敏感資訊到 stdout</li>
<li>JWT token 過期時間 24 小時過長（建議 1-2 小時）</li>
<li><code>questions.py</code> 超過 1000 行，應拆分</li>
<li><code>main.py</code> 與 <code>dependencies.py</code> 函式重複</li>
<li>測試覆蓋不足</li>
<li><code>requirements.txt</code> 未鎖定版本號</li>
<li>缺少 <code>.gitignore</code></li>
</ol>
<h2 id="品質趨勢">品質趨勢</h2>
<table>
<tr><th>報告</th><th>方向</th><th>分數</th></tr>
<tr><td>#1 (2026-02-15)</td><td>SQL 注入 + 硬編碼密碼 + Cookie</td><td>2/5</td></tr>
<tr><td>#2 (2026-02-16)</td><td>SECRET_KEY + CORS + 錯誤洩漏</td><td>3/5</td></tr>
</table>

      </div>

      <nav class="article-nav"><a href="qa-system-安全優化報告-3---print--8dfd3c09.html" class="nav-prev"><span class="nav-label">&larr; 上一篇</span><span class="nav-title">QA System 安全優化報告 #3 - print() 洩漏修復與 JWT/依賴版本鎖定</span></a><a href="qa-system-安全優化報告-1---sql-注入修復-8457728e.html" class="nav-next"><span class="nav-label">下一篇 &rarr;</span><span class="nav-title">QA System 安全優化報告 #1 - SQL 注入修復與 Cookie 安全強化</span></a></nav>

      <a href="../" class="back-link">&larr; 返回首頁</a>
    </article>
  </main>

  <button class="back-to-top" id="backToTop" onclick="window.scrollTo({top:0,behavior:'smooth'})" aria-label="回到頂部">&uarr;</button>

  <footer>
    <div class="container">
      <p>Powered by RAG Knowledge Base</p>
    </div>
  </footer>
  <script>
    function toggleTheme(){const b=document.body;b.classList.toggle('dark');localStorage.setItem('theme',b.classList.contains('dark')?'dark':'light')}
    if(localStorage.getItem('theme')==='dark')document.body.classList.add('dark');
    window.addEventListener('scroll',function(){
      const prog=document.getElementById('readingProgress');
      const btn=document.getElementById('backToTop');
      const h=document.documentElement.scrollHeight-window.innerHeight;
      const pct=h>0?(window.scrollY/h)*100:0;
      prog.style.width=pct+'%';
      btn.classList.toggle('visible',window.scrollY>300);
    });
  </script>
</body>
</html>
