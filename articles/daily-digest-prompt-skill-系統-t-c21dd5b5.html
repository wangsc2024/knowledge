<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Daily-Digest-Prompt Skill 系統 Token 經濟學與漸進式上下文載入優化方案（2026）">
  <title>Daily-Digest-Prompt Skill 系統 Token 經濟學與漸進式上下文載入優化方案（2026） | 知識庫</title>
  <link rel="stylesheet" href="../styles.css">
</head>
<body>
  <div class="reading-progress" id="readingProgress"></div>
  <header>
    <div class="container">
      <a href="../" class="logo">知識庫</a>
      <nav>
        <a href="../#buddhism">佛學</a>
        <a href="../#thinking">思維方法</a>
        <a href="../#ai">AI技術</a>
        <a href="../#claude">Claude Code</a>
        <a href="../#game">遊戲</a>
      </nav>
      <button class="theme-toggle" onclick="toggleTheme()" aria-label="切換深色模式">
        <span class="theme-icon">&#9680;</span>
      </button>
    </div>
  </header>

  <main class="container">
    <article>
      <div class="article-header">
        <span class="category-badge category-claude">Claude Code</span>
        <h1>Daily-Digest-Prompt Skill 系統 Token 經濟學與漸進式上下文載入優化方案（2026）</h1>
        <div class="article-meta">
          <span class="date">2026-02-15</span>
          <div class="tags"><span class="tag">專案優化</span><span class="tag">daily-digest-prompt</span><span class="tag">Token經濟學</span><span class="tag">漸進式載入</span><span class="tag">Skill系統</span><span class="tag">Context Window</span><span class="tag">模板去重</span><span class="tag">架構優化</span></div>
        </div>
      </div>

      <details class="article-toc" open>
        <summary>目錄</summary>
        <ol>
          <li><a href="#一-現況分析-token-消耗地圖">一、現況分析：Token 消耗地圖</a></li>  <li><a href="#1-1-各層-token-消耗估算">1.1 各層 Token 消耗估算</a></li>  <li><a href="#1-2-skill-md-大小分布-高低差-6-3-倍">1.2 SKILL.md 大小分布（高低差 6.3 倍）</a></li>  <li><a href="#1-3-關鍵發現">1.3 關鍵發現</a></li><li><a href="#二-漸進式上下文揭露-progressive-context-disclosur">二、漸進式上下文揭露（Progressive Context Disclosure）</a></li>  <li><a href="#2-1-核心概念">2.1 核心概念</a></li>  <li><a href="#2-2-對-daily-digest-prompt-的具體應用">2.2 對 daily-digest-prompt 的具體應用</a></li>  <li><a href="#2-3-預估節省">2.3 預估節省</a></li><li><a href="#三-模板去重與共用片段抽取">三、模板去重與共用片段抽取</a></li>  <li><a href="#3-1-高重複片段識別">3.1 高重複片段識別</a></li>  <li><a href="#3-2-建議的共用片段架構">3.2 建議的共用片段架構</a></li><li><a href="#四-skill_index-平面化-json-索引">四、SKILL_INDEX 平面化 JSON 索引</a></li>  <li><a href="#4-1-靈感來源">4.1 靈感來源</a></li>  <li><a href="#4-2-建議格式">4.2 建議格式</a></li>  <li><a href="#4-3-優勢">4.3 優勢</a></li><li><a href="#五-token-預算管理機制">五、Token 預算管理機制</a></li>  <li><a href="#5-1-概念">5.1 概念</a></li>  <li><a href="#5-2-實施方式">5.2 實施方式</a></li><li><a href="#六-具體實施路線圖">六、具體實施路線圖</a></li>  <li><a href="#phase-1-低成本高收益-預計-2-小時">Phase 1：低成本高收益（預計 2 小時）</a></li>  <li><a href="#phase-2-中等投入-預計-4-小時">Phase 2：中等投入（預計 4 小時）</a></li>  <li><a href="#phase-3-進階優化-預計-6-小時">Phase 3：進階優化（預計 6 小時）</a></li><li><a href="#七-風險評估">七、風險評估</a></li><li><a href="#八-與現有架構的關係">八、與現有架構的關係</a></li>  <li><a href="#與-memory-md-中的-antigravity-skills-參考對照">與 MEMORY.md 中的 antigravity-skills 參考對照</a></li><li><a href="#九-結論">九、結論</a></li><li><a href="#參考來源">參考來源</a></li>
        </ol>
      </details>

      <div class="article-content">
        <h1>Skill 系統 Token 經濟學與漸進式上下文載入優化方案</h1>
<blockquote><p>研究日期：2026-02-16
研究動機：daily-digest-prompt 專案的 15 個 Skill 合計 84,567 bytes SKILL.md，加上 SKILL_INDEX（9,595 bytes）、配置文件（37,011 bytes）、模板（71,693 bytes），Context Window 壓力日益增大。本文從 Token 經濟學角度提出系統性優化方案。</p>
</blockquote>
<hr>
<h2 id="一-現況分析-token-消耗地圖">一、現況分析：Token 消耗地圖</h2>
<h3 id="1-1-各層-token-消耗估算">1.1 各層 Token 消耗估算</h3>
<p>以 1 token 約 4 bytes（英文）或 2-3 bytes（中文）估算：</p>
<table>
<tr><th>層級</th><th>檔案數</th><th>總大小</th><th>估算 Token 數</th><th>佔比</th></tr>
<tr><td>SKILL.md（15 個）</td><td>15</td><td>84,567 B</td><td>~35,000</td><td>37%</td></tr>
<tr><td>模板（sub-agent + auto-tasks）</td><td>19</td><td>71,693 B</td><td>~30,000</td><td>32%</td></tr>
<tr><td>配置（pipeline/routing/等）</td><td>7+</td><td>~37,000 B</td><td>~15,000</td><td>16%</td></tr>
<tr><td>SKILL_INDEX.md</td><td>1</td><td>9,595 B</td><td>~4,000</td><td>4%</td></tr>
<tr><td>主 Prompt（daily/todoist）</td><td>2</td><td>13,864 B</td><td>~5,500</td><td>6%</td></tr>
<tr><td>共用前言</td><td>1</td><td>1,180 B</td><td>~500</td><td>1%</td></tr>
<tr><td><strong>合計</strong></td><td></td><td><strong>~218 KB</strong></td><td><strong>~90,000</strong></td><td><strong>100%</strong></td></tr>
</table>
<h3 id="1-2-skill-md-大小分布-高低差-6-3-倍">1.2 SKILL.md 大小分布（高低差 6.3 倍）</h3>
<table>
<tr><th>排名</th><th>Skill</th><th>大小</th><th>特徵</th></tr>
<tr><td>1</td><td>task-manager</td><td>11,600 B</td><td>最大，含完整 CRUD 操作流程</td></tr>
<tr><td>2</td><td>ntfy-notify</td><td>8,875 B</td><td>多平台通知格式</td></tr>
<tr><td>3</td><td>gmail</td><td>8,875 → 10,019 B</td><td>OAuth2 流程複雜</td></tr>
<tr><td>4</td><td>todoist</td><td>7,879 B</td><td>API v1 遷移後指引</td></tr>
<tr><td>5</td><td>api-cache</td><td>6,414 B</td><td>快取/降級邏輯</td></tr>
<tr><td>...</td><td>...</td><td>...</td><td>...</td></tr>
<tr><td>14</td><td>hackernews-ai-digest</td><td>1,848 B</td><td>最精簡</td></tr>
</table>
<h3 id="1-3-關鍵發現">1.3 關鍵發現</h3>
<ol>
<li><strong>一次載入全部 Skill 是不必要的</strong>：daily-digest 每次實際使用 11/15 個 Skill；Todoist 單次執行通常只用 3-5 個</li>
<li><strong>SKILL_INDEX 每次全量載入</strong>：9,595 bytes 的索引包含完整路由決策樹和鏈式組合模式，但大部分執行路徑只用到其中一小段</li>
<li><strong>配置文件非按需載入</strong>：pipeline.yaml + routing.yaml 在啟動時全量讀入，但 Todoist Agent 不需要 pipeline.yaml</li>
<li><strong>模板重複度高</strong>：19 個模板中有大量結構相同的段落（研究註冊表檢查、去重查詢、品質自評迴圈、DONE 認證）</li>
</ol>
<hr>
<h2 id="二-漸進式上下文揭露-progressive-context-disclosur">二、漸進式上下文揭露（Progressive Context Disclosure）</h2>
<h3 id="2-1-核心概念">2.1 核心概念</h3>
<p>借鑑 antigravity-skills 的三級揭露策略：</p>
<table>
<tr><th>階段</th><th>Token 預算</th><th>載入內容</th><th>時機</th></tr>
<tr><td><strong>啟動</strong></td><td>~100 tokens</td><td>角色宣告 + 能力摘要</td><td>Agent 初始化</td></tr>
<tr><td><strong>激活</strong></td><td>&lt;5,000 tokens</td><td>核心操作指引</td><td>Skill 被觸發時</td></tr>
<tr><td><strong>深入</strong></td><td>按需</td><td>完整 API 參考、邊界案例</td><td>遇到特定場景時</td></tr>
</table>
<h3 id="2-2-對-daily-digest-prompt-的具體應用">2.2 對 daily-digest-prompt 的具體應用</h3>
<p>#### 層級 1：SKILL_INDEX 精簡版（~1,000 tokens → 節省 ~3,000 tokens）</p>
<p>目前 SKILL_INDEX.md 包含：速查表 + 強制規則 + 標籤路由 + 決策樹 + 鏈式組合 + 外部服務對應 + 團隊模式 + 禁止行為，共 ~4,000 tokens。</p>
<p><strong>建議</strong>：拆分為兩層</p>
<ul>
<li><code>SKILL_INDEX_LITE.md</code>（~1,000 tokens）：僅含速查表（名稱 + 觸發關鍵字）+ 禁止行為</li>
<li><code>SKILL_INDEX_FULL.md</code>（保留原檔）：在需要路由決策或團隊協調時才載入</li>
</ul>
<p>#### 層級 2：SKILL.md 分層結構</p>
<p>每個 SKILL.md 重構為三段：</p>
<pre><code class="language-markdown">---
name: todoist
version: 1.0.0
description: 一句話描述
summary: |
  核心操作：查詢(GET /api/v1/tasks/filter)、關閉(POST /api/v1/tasks/{id}/close)、更新(POST /api/v1/tasks/{id})
  注意：filter 端點為 /tasks/filter?query=today，非 /tasks?filter=
---</code></pre>
<ul>
<li><strong>frontmatter</strong>（~100 tokens）：啟動時載入，提供能力概覽</li>
<li><strong>## 核心操作</strong>（~300-500 tokens）：激活時載入，80% 場景夠用</li>
<li><strong>## 進階用法 / 邊界案例</strong>（剩餘）：僅在遇到錯誤或特殊場景時載入</li>
</ul>
<p>#### 層級 3：配置文件按需載入</p>
<table>
<tr><th>配置</th><th>現況</th><th>建議</th></tr>
<tr><td>pipeline.yaml</td><td>daily-digest 啟動時全量載入</td><td>保持（daily-digest 專用）</td></tr>
<tr><td>routing.yaml</td><td>Todoist 啟動時全量載入</td><td>拆分為 <code>routing-lite.yaml</code>（標籤映射表）+ <code>routing-rules.yaml</code>（規則說明）</td></tr>
<tr><td>frequency-limits.yaml</td><td>啟動時載入</td><td>改為「進入步驟 2.5 時才載入」</td></tr>
<tr><td>scoring.yaml</td><td>啟動時載入</td><td>改為「進入步驟 3 時才載入」</td></tr>
</table>
<h3 id="2-3-預估節省">2.3 預估節省</h3>
<table>
<tr><th>場景</th><th>現有 Token 消耗</th><th>優化後消耗</th><th>節省</th></tr>
<tr><td>Daily Digest（典型）</td><td>~45,000</td><td>~28,000</td><td>~38%</td></tr>
<tr><td>Todoist（有任務）</td><td>~35,000</td><td>~22,000</td><td>~37%</td></tr>
<tr><td>Todoist（觸發自動任務）</td><td>~40,000</td><td>~25,000</td><td>~38%</td></tr>
<tr><td>子 Agent（研究任務）</td><td>~12,000</td><td>~7,000</td><td>~42%</td></tr>
</table>
<hr>
<h2 id="三-模板去重與共用片段抽取">三、模板去重與共用片段抽取</h2>
<h3 id="3-1-高重複片段識別">3.1 高重複片段識別</h3>
<p>分析 19 個模板，發現以下段落在 5+ 個模板中近乎相同：</p>
<table>
<tr><th>片段</th><th>出現次數</th><th>大小</th><th>建議</th></tr>
<tr><td>研究註冊表檢查</td><td>10 個模板</td><td>~800 B/個</td><td>抽為 <code>templates/shared/registry-check.md</code></td></tr>
<tr><td>去重查詢（兩階段）</td><td>10 個模板</td><td>~1,200 B/個</td><td>抽為 <code>templates/shared/dedup-search.md</code></td></tr>
<tr><td>品質自評迴圈</td><td>10+ 個模板</td><td>~600 B/個</td><td>已有 <code>quality-gate.md</code>，但多數模板仍內嵌</td></tr>
<tr><td>DONE 認證格式</td><td>10+ 個模板</td><td>~400 B/個</td><td>已有 <code>done-cert.md</code>，但多數模板仍內嵌</td></tr>
<tr><td>KB 匯入流程</td><td>8 個模板</td><td>~500 B/個</td><td>抽為 <code>templates/shared/kb-import.md</code></td></tr>
</table>
<p><strong>合計重複量</strong>：~3,500 B x 10 個模板 = ~35,000 B（~14,000 tokens 的重複浪費）</p>
<h3 id="3-2-建議的共用片段架構">3.2 建議的共用片段架構</h3>
<pre><code class="language-plaintext">templates/shared/
  preamble.md          # 已有：共用前言
  done-cert.md         # 已有：DONE 認證
  quality-gate.md      # 已有：品質閘門
  registry-check.md    # 新增：研究註冊表檢查
  dedup-search.md      # 新增：去重查詢
  kb-import.md         # 新增：KB 匯入流程</code></pre>
<p>模板改為引用方式：</p>
<pre><code class="language-markdown">## 研究註冊表檢查
讀取 `templates/shared/registry-check.md` 並依指示執行。</code></pre>
<hr>
<h2 id="四-skill_index-平面化-json-索引">四、SKILL_INDEX 平面化 JSON 索引</h2>
<h3 id="4-1-靈感來源">4.1 靈感來源</h3>
<p>antigravity-skills 專案使用 <code>skills_index.json</code>（平面化 JSON）取代 Markdown 索引。LLM 解析 JSON 的速度和準確度優於 Markdown 表格。</p>
<h3 id="4-2-建議格式">4.2 建議格式</h3>
<pre><code class="language-json">{
  &quot;version&quot;: 2,
  &quot;skills&quot;: [
    {
      &quot;name&quot;: &quot;todoist&quot;,
      &quot;triggers&quot;: [&quot;待辦&quot;, &quot;任務&quot;, &quot;todo&quot;],
      &quot;summary&quot;: &quot;待辦事項查詢/新增/完成&quot;,
      &quot;path&quot;: &quot;skills/todoist/SKILL.md&quot;,
      &quot;size_tokens&quot;: 3200,
      &quot;chains_with&quot;: [&quot;api-cache&quot;, &quot;ntfy-notify&quot;],
      &quot;required_by&quot;: [&quot;daily-digest&quot;, &quot;todoist-agent&quot;]
    }
  ]
}</code></pre>
<h3 id="4-3-優勢">4.3 優勢</h3>
<ol>
<li><strong>精確解析</strong>：JSON 結構比 Markdown 表格更易被 LLM 精確理解</li>
<li><strong>可搜尋</strong>：支援程式化查詢（配合 jq 或 Python）</li>
<li><strong>附帶 Token 估算</strong>：<code>size_tokens</code> 讓 Agent 決定是否值得載入</li>
<li><strong>依賴關係明確</strong>：<code>chains_with</code> 和 <code>required_by</code> 支援智慧預載</li>
</ol>
<hr>
<h2 id="五-token-預算管理機制">五、Token 預算管理機制</h2>
<h3 id="5-1-概念">5.1 概念</h3>
<p>為每次 Agent 執行設定 Token 預算上限，並在執行過程中追蹤消耗：</p>
<pre><code class="language-yaml"># config/token-budget.yaml
budgets:
  daily-digest:
    total: 50000
    init: 5000      # preamble + index + memory
    per_step: 8000   # 每個 pipeline step
    finalize: 5000   # notification + memory update
  todoist-single:
    total: 40000
    init: 6000
    per_task: 10000
    auto_task: 8000
  todoist-team:
    phase1: 8000     # 查詢 Agent
    phase2: 12000    # 每個執行 Agent
    phase3: 5000     # 組裝 Agent</code></pre>
<h3 id="5-2-實施方式">5.2 實施方式</h3>
<p>不需要精確的 Token 計數器（LLM 無法精確自測），而是用<strong>啟發式規則</strong>：</p>
<ol>
<li><strong>SKILL.md 大小分級</strong>：小（&lt;3KB，直接載入）、中（3-6KB，載入核心段）、大（&gt;6KB，分層載入）</li>
<li><strong>配置文件延遲載入</strong>：只在進入對應步驟時才 Read</li>
<li><strong>模板引用取代內嵌</strong>：用 <code>Read templates/shared/xxx.md</code> 取代重複段落</li>
</ol>
<hr>
<h2 id="六-具體實施路線圖">六、具體實施路線圖</h2>
<h3 id="phase-1-低成本高收益-預計-2-小時">Phase 1：低成本高收益（預計 2 小時）</h3>
<table>
<tr><th>項目</th><th>動作</th><th>預估節省</th></tr>
<tr><td>模板共用片段抽取</td><td>建立 3 個 shared 檔案，10 個模板改為引用</td><td>~14,000 tokens/次</td></tr>
<tr><td>配置延遲載入</td><td>frequency-limits + scoring 改為按需讀取</td><td>~3,000 tokens/次</td></tr>
<tr><td>preamble + SKILL_INDEX 讀取順序優化</td><td>確保不重複載入</td><td>~500 tokens/次</td></tr>
</table>
<h3 id="phase-2-中等投入-預計-4-小時">Phase 2：中等投入（預計 4 小時）</h3>
<table>
<tr><th>項目</th><th>動作</th><th>預估節省</th></tr>
<tr><td>SKILL.md 三層重構</td><td>15 個 Skill 加入 summary frontmatter</td><td>~8,000 tokens/次</td></tr>
<tr><td>SKILL_INDEX 精簡版</td><td>建立 LITE 版，啟動時僅載入 LITE</td><td>~3,000 tokens/次</td></tr>
<tr><td>routing.yaml 拆分</td><td>映射表與規則說明分離</td><td>~2,000 tokens/次</td></tr>
</table>
<h3 id="phase-3-進階優化-預計-6-小時">Phase 3：進階優化（預計 6 小時）</h3>
<table>
<tr><th>項目</th><th>動作</th><th>預估節省</th></tr>
<tr><td>平面化 JSON 索引</td><td>建立 skills_index.json + 程式化路由</td><td>精確度提升</td></tr>
<tr><td>Token 預算配置</td><td>建立 token-budget.yaml + 啟發式追蹤</td><td>可觀測性</td></tr>
<tr><td>Skill 按需載入驗證</td><td>追蹤各執行路徑實際載入的 Skill 數量</td><td>數據驅動優化</td></tr>
</table>
<hr>
<h2 id="七-風險評估">七、風險評估</h2>
<table>
<tr><th>風險</th><th>影響</th><th>緩解措施</th></tr>
<tr><td>分層過多增加 Read 呼叫次數</td><td>延遲增加</td><td>控制在 3 層以內，常用路徑不超過 5 次 Read</td></tr>
<tr><td>精簡版遺漏關鍵資訊</td><td>功能異常</td><td>保留完整版作為 fallback，精簡版含「若不確定，讀取完整版」提示</td></tr>
<tr><td>JSON 索引與 Markdown 索引不同步</td><td>路由錯誤</td><td>用 CI 腳本自動從 SKILL.md frontmatter 生成 JSON</td></tr>
<tr><td>模板引用增加間接性</td><td>除錯困難</td><td>共用片段加入版本號，變更時記錄 changelog</td></tr>
</table>
<hr>
<h2 id="八-與現有架構的關係">八、與現有架構的關係</h2>
<p>本優化方案完全符合專案的「文件驅動架構」原則：</p>
<ol>
<li><strong>Prompt 是薄層調度器</strong> — 進一步精簡 Prompt 層</li>
<li><strong>按需載入</strong> — 將「按需」從模板層擴展到配置層和 Skill 層</li>
<li><strong>改配置不改 prompt</strong> — token-budget.yaml 作為新增配置</li>
<li><strong>單一定義處</strong> — 共用片段消除重複定義</li>
</ol>
<h3 id="與-memory-md-中的-antigravity-skills-參考對照">與 MEMORY.md 中的 antigravity-skills 參考對照</h3>
<table>
<tr><th>antigravity-skills 特性</th><th>daily-digest-prompt 現況</th><th>本方案建議</th></tr>
<tr><td>漸進式上下文揭露（3 級）</td><td>部分（模板按需載入）</td><td>擴展到 Skill + 配置層</td></tr>
<tr><td>平面化 JSON 索引</td><td>無（Markdown 表格）</td><td>Phase 3 建立</td></tr>
<tr><td>Token 預算（80% 方差來源）</td><td>無追蹤</td><td>Phase 3 配置</td></tr>
<tr><td>Evidence-Based 驗證</td><td>已有（pipeline.yaml finalize）</td><td>保持</td></tr>
</table>
<hr>
<h2 id="九-結論">九、結論</h2>
<p>daily-digest-prompt 專案的 Skill 系統已具備良好的模組化基礎，但在 Token 經濟學方面仍有顯著優化空間。核心問題是「一次載入太多、重複載入太多」。</p>
<p>透過三階段實施（模板去重 → Skill 分層 → JSON 索引），預估可將單次執行的 Context Window 消耗降低 35-42%，相當於每次執行節省 ~15,000-20,000 tokens。這不僅降低 API 成本，更重要的是為未來新增 Skill 和更複雜的任務鏈保留了 Context Window 空間。</p>
<hr>
<h2 id="參考來源">參考來源</h2>
<ol>
<li><strong>antigravity-skills 專案</strong>（GitHub: guanyang/antigravity-skills）— 57 Skills 生態系統的漸進式上下文揭露策略</li>
<li><strong>知識庫筆記「AI Agent 記憶系統：架構演進」</strong>— 三層記憶模型（感官/短期/長期）對應 Context Window 管理</li>
<li><strong>知識庫筆記「JSONL 結構化日誌系統設計」</strong>— 本專案 Hook 系統的 Token 使用追蹤啟示</li>
<li><strong>知識庫筆記「Claude Code Hooks 完整事件體系」</strong>— Hook 機制可用於 Token 消耗監控</li>
<li><strong>知識庫筆記「Daily-Digest-Prompt 專案優化建議報告 2026-02-15」</strong>— 前次優化聚焦可維護性/UX/可觀測性，本次補充 Token 經濟學維度</li>
</ol>

      </div>

      <a href="../" class="back-link">&larr; 返回首頁</a>
    </article>
  </main>

  <button class="back-to-top" id="backToTop" onclick="window.scrollTo({top:0,behavior:'smooth'})" aria-label="回到頂部">&uarr;</button>

  <footer>
    <div class="container">
      <p>Powered by RAG Knowledge Base</p>
    </div>
  </footer>
  <script>
    function toggleTheme(){const b=document.body;b.classList.toggle('dark');localStorage.setItem('theme',b.classList.contains('dark')?'dark':'light')}
    if(localStorage.getItem('theme')==='dark')document.body.classList.add('dark');
    window.addEventListener('scroll',function(){
      const prog=document.getElementById('readingProgress');
      const btn=document.getElementById('backToTop');
      const h=document.documentElement.scrollHeight-window.innerHeight;
      const pct=h>0?(window.scrollY/h)*100:0;
      prog.style.width=pct+'%';
      btn.classList.toggle('visible',window.scrollY>300);
    });
  </script>
</body>
</html>
